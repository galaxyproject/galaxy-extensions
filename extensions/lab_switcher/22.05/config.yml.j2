id: lab_switcher
type: masthead
activate: true
icon: fa-connectdevelop
tooltip: Switch sites
function: >
  const LABS = [
    {
      label: "Base site",
      url: "https://{{ galaxy_base_domain }}",
    },
    {% for lab in galaxy_labs %}
    {% if 'hidden' not in lab or not lab.hidden %}
    {
      label: "{{ lab.brand }}",
      url: "https://{{ lab.name }}.{{ galaxy_base_domain }}",
    },
    {% endif %}
    {% endfor %}
  ];

  function getDropdown() {
    return document.querySelector('#lab_switcher ul');
  }

  function showDomainSwitcher() {
    const dropdown = getDropdown();
    if (dropdown) {
      dropdown.remove();
      return;
    }

    const listItems = LABS
      .filter( site => site.url.replace(/\/$/, '') !== window.location.origin )
      .map(site => `<li>
        <a class="dropdown-item" role="menuitem" href="${site.url}">${site.label}</a>
      </li>`);
    let ul = document.createElement('ul');
    ul.className = "dropdown-menu show";
    ul.innerHTML = listItems.join('\n');
    const parent = document.getElementById("lab_switcher");
    parent.style.position = 'relative';
    parent.append(ul);

    // Hide tooltip on click
    let tip = document.getElementsByClassName('tooltip')[0];
    if (tip) tip.style.display = 'none';

    // Stop tooltips from displaying on top of the dropdown
    getDropdown().addEventListener('mouseover', function(event) {
      let tip = document.getElementsByClassName('tooltip')[0];
      if (tip) tip.style.display = 'none';
    });

    // Close dropdown when clicking outside of it
    function closeDropdownOnClick(event) {
      const parent = document.getElementById("subdomain_switcher");
      const dropdown = getDropdown();
      if (dropdown && !parent.contains(event.target)) {
        dropdown.remove();
      }
    }
    document.addEventListener('click', closeDropdownOnClick);
    const iframe = document.getElementById('galaxy_main');
    iframe.contentDocument
      .addEventListener('click', closeDropdownOnClick);
  }
  showDomainSwitcher();
